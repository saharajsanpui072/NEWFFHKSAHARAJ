<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saharaj Pro Connect - Final Fix</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --primary: #075e54; --secondary: #128c7e; --danger: #ea4335; --success: #34a853; --chat-bg: #e5ddd5; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; overflow: hidden; height: 100vh; }
        
        .app-bar { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { padding: 10px; height: calc(100vh - 70px); overflow-y: auto; }
        .user-card { background: white; padding: 15px; margin-bottom: 8px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; border-left: 5px solid var(--success); }

        #chat-window { position: fixed; inset: 0; background: var(--chat-bg); display: none; flex-direction: column; z-index: 500; }
        .chat-header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
        .msg { max-width: 75%; padding: 12px; border-radius: 12px; font-size: 15px; position: relative; word-wrap: break-word; }
        .msg.sent { align-self: flex-end; background: #dcf8c6; }
        .msg.received { align-self: flex-start; background: white; }

        #msg-menu { position: fixed; background: white; padding: 10px; border-radius: 15px; display: none; flex-direction: column; gap: 8px; z-index: 2000; box-shadow: 0 5px 25px rgba(0,0,0,0.3); width: 140px; }
        .menu-btn { padding: 10px; border: none; border-radius: 8px; font-weight: bold; color: white; cursor: pointer; font-size: 14px; }

        #call-screen { position: fixed; inset: 0; background: black; display: none; flex-direction: column; z-index: 1000; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 90px; height: 130px; border-radius: 10px; border: 2px solid white; object-fit: cover; z-index: 10; }
        #call-timer { position: absolute; top: 30px; left: 50%; transform: translateX(-50%); color: white; font-size: 20px; font-weight: bold; background: rgba(0,0,0,0.4); padding: 5px 15px; border-radius: 20px; }
        #net-status { position: absolute; top: 70px; left: 50%; transform: translateX(-50%); color: #00ff00; font-size: 12px; }

        .call-controls { position: absolute; bottom: 40px; width: 100%; display: flex; justify-content: center; gap: 15px; flex-wrap: wrap; z-index: 20; }
        .control-btn { width: 55px; height: 55px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 22px; cursor: pointer; background: rgba(255,255,255,0.2); backdrop-filter: blur(5px); }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:3000;">
        <div style="background:#f0f2f5; padding:30px; border-radius:20px; width:85%; text-align:center;">
            <h2>Saharaj Pro</h2>
            <input type="text" id="usernameInput" placeholder="Enter Name..." style="width:100%; padding:14px; margin:15px 0; border:1px solid #ccc; border-radius:10px;">
            <button onclick="handleRegister()" style="width:100%; background:var(--primary); color:white; border:none; padding:14px; border-radius:10px;">Login</button>
        </div>
    </div>

    <div class="app-bar">
        <div><b id="myDisplayName">Saharaj App</b><br><small id="myNetDisplay">Net: 0ms</small></div>
        <button onclick="logout()" style="background:none; border:1px solid white; color:white; padding:5px; border-radius:5px;">Logout</button>
    </div>

    <div class="user-list-container" id="userList"></div>

    <div id="chat-window">
        <div class="chat-header">
            <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:25px;">‚Üê</button>
            <b id="chatWithUserName">User</b>
            <button onclick="initiateCall()" style="background:var(--success); border:none; color:white; padding:8px 15px; border-radius:20px;">üìû Call</button>
        </div>
        <div id="chat-messages" onclick="hideMenu()"></div>
        <div style="background:#f0f0f0; padding:10px; display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1; padding:12px; border-radius:25px; border:1px solid #ccc;" placeholder="Type here...">
            <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:50%;">‚û§</button>
        </div>
    </div>

    <div id="call-screen">
        <div id="call-timer">00:00</div>
        <div id="net-status">Opponent: 0ms</div>
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="control-btn" id="camBtn" onclick="toggleCamera()">üìπ</button>
            <button class="control-btn" id="micBtn" onclick="toggleMic()">üé§</button>
            <button class="control-btn" id="spkBtn" onclick="toggleSpeaker()">üîä</button>
            <button class="control-btn" onclick="switchCamera()">üîÑ</button>
            <button class="control-btn" style="background:var(--danger)" onclick="endCall()">üìû</button>
        </div>
    </div>

    <div id="msg-menu">
        <button class="menu-btn" style="background:var(--secondary)" onclick="menuReply()">Reply</button>
        <button class="menu-btn" style="background:var(--success)" onclick="menuEdit()">Edit</button>
        <button class="menu-btn" style="background:var(--danger)" onclick="menuDelete()">Delete</button>
    </div>

    <div id="incoming-alert" style="position:fixed; top:20px; left:10px; right:10px; background:white; padding:20px; border-radius:20px; display:none; z-index:4000; text-align:center; box-shadow:0 10px 50px rgba(0,0,0,0.5);">
        <h3 id="callerNameText">Incoming...</h3>
        <button onclick="acceptCall()" style="background:var(--success); color:white; padding:10px 30px; border:none; border-radius:10px;">Accept</button>
        <button onclick="rejectCall()" style="background:var(--danger); color:white; padding:10px 30px; border:none; border-radius:10px; margin-left:10px;">Reject</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMvHlgZmaxdNIHWMVc8nXb1h-A0YUR0qI",
            authDomain: "mycallingapp-8677d.firebaseapp.com",
            projectId: "mycallingapp-8677d",
            storageBucket: "mycallingapp-8677d.firebasestorage.app",
            messagingSenderId: "75951551570",
            appId: "1:75951551570:android:d7de2090c4c70bba7fdb8b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let myId = localStorage.getItem('saharaj_user_id'), myName = localStorage.getItem('saharaj_user_name');
        let localStream, pc, currentCallId, targetUserId, timerInt, callSeconds = 0;
        let selectedMsgId, selectedMsgText, replyingTo = null;
        let isCamOn = true, isMicOn = true, isSpkOn = true;
        const ringtone = new Audio('https://www.soundjay.com/phone/phone-calling-1.mp3'); ringtone.loop = true;

        window.onload = () => { if (myId && myName) initApp(); monitorNet(); };
        document.addEventListener("visibilitychange", () => { if (document.hidden && currentCallId) endCall(); });

        async function monitorNet() {
            setInterval(async () => {
                const start = Date.now();
                try {
                    await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors', cache: 'no-store' });
                    const lat = Date.now() - start;
                    document.getElementById('myNetDisplay').innerText = `Net: ${lat}ms`;
                    if(myId) db.collection('users').doc(myId).update({ net: lat, status: 'online', lastSeen: Date.now() });
                } catch(e) {}
            }, 3000);
        }

        async function initApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('myDisplayName').innerText = myName;
            await db.collection('users').doc(myId).set({ name: myName, status: 'online', incoming: null });

            navigator.mediaDevices.getUserMedia({ video: true, audio: { noiseSuppression: true } }).then(s => {
                localStream = s; document.getElementById('localVideo').srcObject = s;
            });

            db.collection('users').where('status', '==', 'online').onSnapshot(snap => {
                const list = document.getElementById('userList'); list.innerHTML = '';
                snap.forEach(doc => {
                    if (doc.id !== myId && (Date.now() - doc.data().lastSeen < 10000)) {
                        list.innerHTML += `<div class="user-card" onclick="openChat('${doc.id}', '${doc.data().name}')">
                            <span><b>${doc.data().name}</b><br><small>üì∂ ${doc.data().net || 0}ms</small></span>
                            <span style="color:var(--success)">‚óè Online</span>
                        </div>`;
                    }
                });
            });

            db.collection('users').doc(myId).onSnapshot(snap => {
                const data = snap.data();
                if (data?.incoming && !currentCallId) {
                    currentCallId = data.incoming; targetUserId = data.callerId;
                    document.getElementById('callerNameText').innerText = data.callerName + " calling...";
                    document.getElementById('incoming-alert').style.display = 'block';
                }
                if (data?.callEnded) endCall(false);
            });
        }

        function openChat(id, name) {
            targetUserId = id; document.getElementById('chatWithUserName').innerText = name;
            document.getElementById('chat-window').style.display = 'flex';
            const chatId = myId < targetUserId ? myId+"_"+targetUserId : targetUserId+"_"+myId;
            const msgDiv = document.getElementById('chat-messages');
            
            db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snap => {
                msgDiv.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const div = document.createElement('div');
                    div.className = `msg ${d.sender === myId ? 'sent' : 'received'}`;
                    div.innerHTML = (d.reply ? `<small style="display:block;opacity:0.6;border-left:2px solid green;padding-left:5px;">${d.reply}</small>` : '') + d.text;
                    
                    let lastTap = 0;
                    div.addEventListener('touchend', (e) => {
                        let now = new Date().getTime();
                        if (now - lastTap < 300) {
                            selectedMsgId = doc.id; selectedMsgText = d.text;
                            const menu = document.getElementById('msg-menu');
                            menu.style.display = 'flex';
                            menu.style.left = Math.min(e.changedTouches[0].clientX, window.innerWidth-150) + "px";
                            menu.style.top = Math.min(e.changedTouches[0].clientY, window.innerHeight-150) + "px";
                        }
                        lastTap = now;
                    });
                    msgDiv.appendChild(div);
                });
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        async function sendMessage() {
            const t = document.getElementById('chatInput').value; if (!t) return;
            const chatId = myId < targetUserId ? myId+"_"+targetUserId : targetUserId+"_"+myId;
            await db.collection('chats').doc(chatId).collection('messages').add({
                sender: myId, text: t, reply: replyingTo, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('chatInput').value = ''; document.getElementById('chatInput').focus();
            replyingTo = null;
        }

        function menuReply() { replyingTo = selectedMsgText; hideMenu(); alert("Replying to: " + selectedMsgText); }
        function menuDelete() { const cid = myId < targetUserId ? myId+"_"+targetUserId : targetUserId+"_"+myId; db.collection('chats').doc(cid).collection('messages').doc(selectedMsgId).delete(); hideMenu(); }
        function menuEdit() { const nt = prompt("Edit:", selectedMsgText); if(nt) { const cid = myId < targetUserId ? myId+"_"+targetUserId : targetUserId+"_"+myId; db.collection('chats').doc(cid).collection('messages').doc(selectedMsgId).update({text:nt}); } hideMenu(); }
        function hideMenu() { document.getElementById('msg-menu').style.display = 'none'; }

        function initiateCall() { if(targetUserId) startCall(targetUserId); }
        async function startCall(id) {
            targetUserId = id; ringtone.play(); setupPC();
            const callDoc = db.collection('calls').doc(); currentCallId = callDoc.id;
            pc.onicecandidate = e => e.candidate && callDoc.collection('offCand').add(e.candidate.toJSON());
            const offer = await pc.createOffer(); await pc.setLocalDescription(offer);
            await callDoc.set({ offer: { sdp: offer.sdp, type: offer.type } });
            await db.collection('users').doc(targetUserId).update({ incoming: currentCallId, callerName: myName, callerId: myId });
            document.getElementById('call-screen').style.display = 'flex';
            callDoc.onSnapshot(s => { if(s.data()?.answer && !pc.currentRemoteDescription) { pc.setRemoteDescription(new RTCSessionDescription(s.data().answer)); startTimer(); } });
            callDoc.collection('ansCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
        }

        async function acceptCall() {
            document.getElementById('incoming-alert').style.display = 'none'; document.getElementById('call-screen').style.display = 'flex';
            setupPC(); const callDoc = db.collection('calls').doc(currentCallId);
            pc.onicecandidate = e => e.candidate && callDoc.collection('ansCand').add(e.candidate.toJSON());
            const callData = (await callDoc.get()).data(); await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await pc.createAnswer(); await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { sdp: answer.sdp, type: answer.type } });
            callDoc.collection('offCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            startTimer();
        }

        function startTimer() {
            ringtone.pause(); ringtone.currentTime = 0;
            timerInt = setInterval(() => {
                callSeconds++; let m = Math.floor(callSeconds/60), s = callSeconds%60;
                document.getElementById('call-timer').innerText = (m<10?'0'+m:m)+":"+(s<10?'0'+s:s);
            }, 1000);
            db.collection('users').doc(targetUserId).onSnapshot(s => { document.getElementById('net-status').innerText = `Opponent: ${s.data()?.net || 0}ms`; });
        }

        function setupPC() {
            pc = new RTCPeerConnection({ iceServers: [{ urls: 'stun:stun1.l.google.com:19302' }] });
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => { document.getElementById('remoteVideo').srcObject = e.streams[0]; };
        }

        function toggleCamera() { isCamOn = !isCamOn; localStream.getVideoTracks()[0].enabled = isCamOn; document.getElementById('camBtn').innerText = isCamOn ? "üìπ" : "üö´"; }
        function toggleMic() { isMicOn = !isMicOn; localStream.getAudioTracks()[0].enabled = isMicOn; document.getElementById('micBtn').innerText = isMicOn ? "üé§" : "üîá"; }
        function toggleSpeaker() { isSpkOn = !isSpkOn; document.getElementById('remoteVideo').muted = !isSpkOn; document.getElementById('spkBtn').innerText = isSpkOn ? "üîä" : "üîà"; }
        async function switchCamera() {
            const track = localStream.getVideoTracks()[0]; const mode = track.getSettings().facingMode === 'user' ? 'environment' : 'user';
            track.stop(); const newStream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: mode } });
            const newTrack = newStream.getVideoTracks()[0]; localStream.addTrack(newTrack);
            pc.getSenders().find(s => s.track.kind === 'video').replaceTrack(newTrack);
            document.getElementById('localVideo').srcObject = localStream;
        }

        async function endCall(not = true) {
            if(not && targetUserId) await db.collection('users').doc(targetUserId).update({ callEnded: true });
            if(myId) await db.collection('users').doc(myId).update({ incoming: null, callEnded: false });
            location.reload();
        }

        function handleRegister() {
            const n = document.getElementById('usernameInput').value; if(!n) return;
            myId = n + "_" + Math.floor(Math.random()*9999); myName = n;
            localStorage.setItem('saharaj_user_id', myId); localStorage.setItem('saharaj_user_name', myName); initApp();
        }
        function closeChat() { document.getElementById('chat-window').style.display = 'none'; }
        function logout() { localStorage.clear(); location.reload(); }
        function rejectCall() { db.collection('users').doc(myId).update({ incoming: null }); document.getElementById('incoming-alert').style.display = 'none'; ringtone.pause(); }
    </script>
</body>
</html>
