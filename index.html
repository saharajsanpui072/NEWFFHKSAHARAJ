<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Saharaj Pro Connect - Advanced Chat</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --primary: #075e54; --secondary: #128c7e; --danger: #ea4335; --success: #34a853; --chat-bg: #e5ddd5; }
        body { font-family: 'Segoe UI', sans-serif; background: #f0f2f5; margin: 0; overflow: hidden; height: 100vh; touch-action: pan-y; }
        
        .app-bar { background: var(--primary); color: white; padding: 12px 15px; display: flex; justify-content: space-between; align-items: center; }
        .user-list-container { padding: 10px; height: calc(100vh - 70px); overflow-y: auto; }
        .user-card { background: white; padding: 15px; margin-bottom: 8px; border-radius: 10px; display: flex; justify-content: space-between; align-items: center; cursor: pointer; }

        /* Chat Window */
        #chat-window { position: fixed; inset: 0; background: var(--chat-bg); display: none; flex-direction: column; z-index: 500; }
        .chat-header { background: var(--primary); color: white; padding: 10px 15px; display: flex; justify-content: space-between; align-items: center; }
        #chat-messages { flex: 1; padding: 15px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; scroll-behavior: smooth; }
        
        /* Message Styling & Swipe */
        .msg-wrapper { position: relative; display: flex; flex-direction: column; transition: transform 0.2s ease; overflow: visible; }
        .msg { max-width: 75%; padding: 10px; border-radius: 10px; font-size: 15px; position: relative; user-select: none; }
        .msg.sent { align-self: flex-end; background: #dcf8c6; }
        .msg.received { align-self: flex-start; background: white; }
        .reply-preview { font-size: 11px; background: rgba(0,0,0,0.05); padding: 4px; border-radius: 4px; border-left: 3px solid var(--primary); margin-bottom: 4px; }

        /* Reply Input Bar */
        #reply-bar { background: #e1e1e1; padding: 5px 15px; display: none; justify-content: space-between; align-items: center; font-size: 12px; }

        /* Video Call Overlay */
        #call-screen { position: fixed; inset: 0; background: black; display: none; flex-direction: column; z-index: 1000; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        .call-controls { position: absolute; bottom: 30px; width: 100%; display: flex; justify-content: center; gap: 12px; flex-wrap: wrap; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; background: rgba(255,255,255,0.2); }

        #incoming-alert { position: fixed; top: 20px; left: 10px; right: 10px; background: white; padding: 20px; border-radius: 15px; z-index: 3000; display: none; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.5); }
    </style>
</head>
<body>

    <div id="auth-screen" style="position:fixed; inset:0; background:white; display:flex; flex-direction:column; align-items:center; justify-content:center; z-index:2000;">
        <div style="background:#f0f2f5; padding:30px; border-radius:15px; width:85%; text-align:center;">
            <h2>Saharaj Pro</h2>
            <input type="text" id="usernameInput" placeholder="Enter Name..." style="width:100%; padding:12px; margin:10px 0; border:1px solid #ccc; border-radius:8px;">
            <button onclick="handleRegister()" style="width:100%; background:var(--primary); color:white; border:none; padding:12px; border-radius:8px;">Login</button>
        </div>
    </div>

    <div class="app-bar">
        <div><b id="myDisplayName">Saharaj App</b></div>
        <button onclick="logout()" style="background:none; border:1px solid white; color:white; border-radius:5px; padding:5px 10px;">Logout</button>
    </div>

    <div class="user-list-container" id="userList"></div>

    <div id="chat-window">
        <div class="chat-header">
            <div style="display:flex; align-items:center; gap:10px;">
                <button onclick="closeChat()" style="background:none; border:none; color:white; font-size:24px;">‚Üê</button>
                <b id="chatWithUserName">User</b>
            </div>
            <button onclick="initiateCall()" style="background:var(--success); border:none; color:white; padding:8px 18px; border-radius:20px; font-weight:bold;">üìû Call Now</button>
        </div>
        <div id="chat-messages"></div>
        <div id="reply-bar">
            <span id="reply-text">Replying...</span>
            <button onclick="cancelReply()" style="border:none; background:none; font-weight:bold;">‚úï</button>
        </div>
        <div class="chat-input-area" style="background:#f0f0f0; padding:10px; display:flex; gap:10px;">
            <input type="text" id="chatInput" style="flex:1; padding:12px; border-radius:25px; border:1px solid #ccc;" placeholder="Type message..." onkeypress="if(event.key==='Enter') sendMessage()">
            <button onclick="sendMessage()" style="background:var(--primary); color:white; border:none; width:45px; height:45px; border-radius:50%;">‚û§</button>
        </div>
    </div>

    <div id="call-screen">
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        <div class="call-controls">
            <button class="control-btn" id="camBtn" onclick="toggleCamera()">üìπ</button>
            <button class="control-btn" id="micBtn" onclick="toggleMic()">üé§</button>
            <button class="control-btn" id="noiseBtn" onclick="toggleNoise()">üîá</button>
            <button class="control-btn" id="spkBtn" onclick="toggleSpeaker()">üîä</button>
            <button class="control-btn btn-danger" onclick="endCall()" style="background:var(--danger)">üìû</button>
        </div>
    </div>

    <div id="incoming-alert">
        <h3 id="callerNameText">Incoming Call...</h3>
        <button onclick="acceptCall()" style="background:var(--success); color:white; border:none; padding:12px 30px; border-radius:8px;">Accept</button>
        <button onclick="rejectCall()" style="background:var(--danger); color:white; border:none; padding:12px 30px; border-radius:8px;">Decline</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMvHlgZmaxdNIHWMVc8nXb1h-A0YUR0qI",
            authDomain: "mycallingapp-8677d.firebaseapp.com",
            projectId: "mycallingapp-8677d",
            storageBucket: "mycallingapp-8677d.firebasestorage.app",
            messagingSenderId: "75951551570",
            appId: "1:75951551570:android:d7de2090c4c70bba7fdb8b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let myId = localStorage.getItem('saharaj_user_id');
        let myName = localStorage.getItem('saharaj_user_name');
        let localStream, pc, currentCallId, targetUserId, replyingTo = null;

        window.onload = () => { if (myId && myName) initApp(); };

        async function initApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('myDisplayName').innerText = myName;
            await db.collection('users').doc(myId).set({ name: myName, status: 'online', incoming: null });
            
            navigator.mediaDevices.getUserMedia({ video: true, audio: true }).then(s => {
                localStream = s; document.getElementById('localVideo').srcObject = s;
            });

            db.collection('users').where('status', '==', 'online').onSnapshot(snap => {
                const list = document.getElementById('userList');
                list.innerHTML = '';
                snap.forEach(doc => {
                    if (doc.id !== myId) {
                        list.innerHTML += `<div class="user-card" onclick="openChat('${doc.id}', '${doc.data().name}')">
                            <span><b>${doc.data().name}</b></span>
                            <span style="color:var(--success)">‚óè Online</span>
                        </div>`;
                    }
                });
            });

            db.collection('users').doc(myId).onSnapshot(snap => {
                const data = snap.data();
                if (data?.incoming) {
                    currentCallId = data.incoming;
                    targetUserId = data.callerId;
                    document.getElementById('incoming-alert').style.display = 'block';
                }
                if (data?.callEnded) endCall(false);
            });
        }

        // --- Chat Advanced Functions ---
        let chatUnsub;
        function openChat(id, name) {
            targetUserId = id;
            document.getElementById('chatWithUserName').innerText = name;
            document.getElementById('chat-window').style.display = 'flex';
            const chatId = myId < targetUserId ? myId + "_" + targetUserId : targetUserId + "_" + myId;
            const msgDiv = document.getElementById('chat-messages');
            
            chatUnsub = db.collection('chats').doc(chatId).collection('messages').orderBy('timestamp', 'asc').onSnapshot(snap => {
                msgDiv.innerHTML = '';
                snap.forEach(doc => {
                    const d = doc.data();
                    const wrapper = document.createElement('div');
                    wrapper.className = 'msg-wrapper';
                    
                    // Swipe logic
                    let startX = 0;
                    wrapper.ontouchstart = (e) => { startX = e.touches[0].clientX; };
                    wrapper.ontouchend = (e) => {
                        let diff = e.changedTouches[0].clientX - startX;
                        if (diff > 100) setReply(d.text); // Swipe right to reply
                    };

                    // Long press logic
                    let pressTimer;
                    wrapper.onmousedown = wrapper.ontouchstart = () => {
                        pressTimer = setTimeout(() => {
                            if (d.sender === myId) handleLongPress(doc.id, d.text);
                        }, 800);
                    };
                    wrapper.onmouseup = wrapper.ontouchend = () => clearTimeout(pressTimer);

                    const div = document.createElement('div');
                    div.className = `msg ${d.sender === myId ? 'sent' : 'received'}`;
                    if(d.reply) div.innerHTML = `<div class="reply-preview">${d.reply}</div>` + d.text;
                    else div.innerText = d.text;

                    wrapper.appendChild(div);
                    msgDiv.appendChild(wrapper);
                });
                msgDiv.scrollTop = msgDiv.scrollHeight;
            });
        }

        async function sendMessage() {
            const t = document.getElementById('chatInput').value;
            if (!t) return;
            const chatId = myId < targetUserId ? myId + "_" + targetUserId : targetUserId + "_" + myId;
            await db.collection('chats').doc(chatId).collection('messages').add({
                sender: myId, text: t, reply: replyingTo, timestamp: firebase.firestore.FieldValue.serverTimestamp()
            });
            document.getElementById('chatInput').value = '';
            cancelReply();
        }

        function handleLongPress(msgId, oldText) {
            const action = confirm("‡¶Æ‡ßá‡¶∏‡ßá‡¶ú ‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá OK ‡¶¶‡¶ø‡¶®, ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶á‡¶≤‡ßá CANCEL ‡¶¶‡¶ø‡¶®‡•§");
            const chatId = myId < targetUserId ? myId + "_" + targetUserId : targetUserId + "_" + myId;
            if (action) {
                const newText = prompt("‡¶è‡¶°‡¶ø‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®:", oldText);
                if (newText) db.collection('chats').doc(chatId).collection('messages').doc(msgId).update({ text: newText });
            } else {
                if (confirm("‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶®‡¶ø‡¶∂‡ßç‡¶ö‡¶ø‡¶§ ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")) 
                    db.collection('chats').doc(chatId).collection('messages').doc(msgId).delete();
            }
        }

        function setReply(text) { replyingTo = text; document.getElementById('reply-bar').style.display = 'flex'; document.getElementById('reply-text').innerText = "Replying: " + text; }
        function cancelReply() { replyingTo = null; document.getElementById('reply-bar').style.display = 'none'; }

        // --- Fixing Call Button ---
        function initiateCall() { if(targetUserId) startCall(targetUserId); else alert("User not selected!"); }

        async function startCall(id) {
            targetUserId = id;
            setupPC();
            const callDoc = db.collection('calls').doc();
            currentCallId = callDoc.id;
            pc.onicecandidate = e => e.candidate && callDoc.collection('offCand').add(e.candidate.toJSON());
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await callDoc.set({ offer: { sdp: offer.sdp, type: offer.type } });
            await db.collection('users').doc(targetUserId).update({ incoming: currentCallId, callerName: myName, callerId: myId });
            document.getElementById('call-screen').style.display = 'flex';
            
            callDoc.onSnapshot(s => { if(s.data()?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(s.data().answer)) });
            callDoc.collection('ansCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
        }

        async function acceptCall() {
            document.getElementById('incoming-alert').style.display = 'none';
            document.getElementById('call-screen').style.display = 'flex';
            setupPC();
            const callDoc = db.collection('calls').doc(currentCallId);
            pc.onicecandidate = e => e.candidate && callDoc.collection('ansCand').add(e.candidate.toJSON());
            const callData = (await callDoc.get()).data();
            await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { sdp: answer.sdp, type: answer.type } });
            callDoc.collection('offCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
        }

        function setupPC() {
            pc = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] });
            const rs = new MediaStream();
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => e.streams[0].getTracks().forEach(t => rs.addTrack(t));
            document.getElementById('remoteVideo').srcObject = rs;
        }

        function toggleCamera() { localStream.getVideoTracks()[0].enabled = !localStream.getVideoTracks()[0].enabled; }
        function toggleMic() { localStream.getAudioTracks()[0].enabled = !localStream.getAudioTracks()[0].enabled; }
        async function toggleNoise() { const t = localStream.getAudioTracks()[0]; await t.applyConstraints({ noiseSuppression: true }); }
        function toggleSpeaker() { document.getElementById('remoteVideo').muted = !document.getElementById('remoteVideo').muted; }
        function handleRegister() {
            const n = document.getElementById('usernameInput').value;
            if(!n) return; myId = n + "_" + Math.floor(Math.random() * 9999); myName = n;
            localStorage.setItem('saharaj_user_id', myId); localStorage.setItem('saharaj_user_name', myName); initApp();
        }
        function closeChat() { document.getElementById('chat-window').style.display = 'none'; if(chatUnsub) chatUnsub(); }
        async function endCall(not = true) {
            if(not && targetUserId) await db.collection('users').doc(targetUserId).update({ callEnded: true });
            location.reload();
        }
        function logout() { localStorage.clear(); location.reload(); }
        function rejectCall() { db.collection('users').doc(myId).update({ incoming: null }); document.getElementById('incoming-alert').style.display = 'none'; }
    </script>
</body>
</html>
