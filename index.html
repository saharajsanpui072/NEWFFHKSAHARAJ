<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Saharaj Pro Connect</title>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

    <style>
        :root { --primary: #075e54; --secondary: #128c7e; --danger: #ea4335; --success: #34a853; }
        body { font-family: 'Segoe UI', sans-serif; background: #e5ddd5; margin: 0; overflow: hidden; }
        
        /* AppBar & Signals */
        .app-bar { background: var(--primary); color: white; padding: 15px; display: flex; justify-content: space-between; align-items: center; }
        .signal-container { display: flex; align-items: center; gap: 5px; font-size: 12px; }
        .bar { width: 4px; background: #ccc; border-radius: 2px; }
        .bar-1 { height: 6px; } .bar-2 { height: 10px; } .bar-3 { height: 14px; } .bar-4 { height: 18px; }
        .online-bar { background: #fff !important; } /* Full signal color */

        /* Screens */
        #auth-screen { position: fixed; inset: 0; background: white; display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 1000; }
        .login-card { background: #f0f2f5; padding: 30px; border-radius: 15px; width: 80%; max-width: 350px; text-align: center; }
        input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ccc; border-radius: 8px; }

        /* Call Screen */
        #call-screen { position: fixed; inset: 0; background: black; display: none; flex-direction: column; z-index: 500; }
        #remoteVideo { width: 100%; height: 100%; object-fit: cover; }
        #localVideo { position: absolute; top: 20px; right: 20px; width: 100px; height: 140px; border-radius: 10px; border: 2px solid white; object-fit: cover; }
        
        /* Opponent Signal on Call Screen */
        #opp-signal { position: absolute; top: 20px; left: 20px; color: white; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 5px; font-size: 12px; }

        /* Controls */
        .call-controls { position: absolute; bottom: 30px; width: 100%; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .control-btn { width: 50px; height: 50px; border-radius: 50%; border: none; color: white; cursor: pointer; font-size: 18px; display: flex; align-items: center; justify-content: center; transition: 0.3s; }
        .active-btn { background: var(--success) !important; }
        .inactive-btn { background: var(--danger) !important; }
        .neutral-btn { background: #444; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <div class="login-card">
            <h2>Saharaj Pro</h2>
            <input type="text" id="usernameInput" placeholder="Enter Name...">
            <button class="btn-call" style="width:100%; background:var(--primary); color:white; padding:12px; border:none; border-radius:8px;" onclick="handleRegister()">Start Now</button>
        </div>
    </div>

    <div class="app-bar">
        <div>
            <span id="myDisplayName">Saharaj App</span>
            <div class="signal-container" id="mySignal">
                <span>My Net:</span>
                <div class="bar bar-1"></div><div class="bar bar-2"></div><div class="bar bar-3"></div><div class="bar bar-4"></div>
            </div>
        </div>
        <button onclick="logout()" style="background:transparent; border:1px solid white; color:white; border-radius:5px; padding:5px 10px;">Logout</button>
    </div>

    <div class="home-menu" style="padding:15px;">
        <h3 style="color:#555">Active Users</h3>
        <div id="userList">Searching...</div>
    </div>

    <div id="call-screen">
        <div id="opp-signal">Opponent Net: Checking...</div>
        <video id="remoteVideo" autoplay playsinline></video>
        <video id="localVideo" autoplay playsinline muted></video>
        
        <div class="call-controls">
            <button class="control-btn neutral-btn" id="camBtn" onclick="toggleCamera()">ðŸ“¹</button>
            <button class="control-btn neutral-btn" id="micBtn" onclick="toggleMic()">ðŸŽ¤</button>
            <button class="control-btn neutral-btn" id="noiseBtn" onclick="toggleNoise()">ðŸ”‡</button>
            <button class="control-btn neutral-btn" id="spkBtn" onclick="toggleSpeaker()">ðŸ”Š</button>
            <button class="control-btn neutral-btn" onclick="switchCamera()">ðŸ”„</button>
            <button class="control-btn inactive-btn" onclick="endCall()">ðŸ“ž</button>
        </div>
    </div>

    <div id="incoming-alert" style="position:fixed; top:20%; left:5%; right:5%; background:white; padding:20px; border-radius:15px; display:none; z-index:2000; text-align:center; box-shadow:0 10px 30px rgba(0,0,0,0.5);">
        <h3 id="callerNameText">Incoming...</h3>
        <button onclick="acceptCall()" style="background:var(--success); color:white; padding:10px 30px; border:none; border-radius:5px; margin-right:10px;">Accept</button>
        <button onclick="rejectCall()" style="background:var(--danger); color:white; padding:10px 30px; border:none; border-radius:5px;">Reject</button>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAMvHlgZmaxdNIHWMVc8nXb1h-A0YUR0qI",
            authDomain: "mycallingapp-8677d.firebaseapp.com",
            projectId: "mycallingapp-8677d",
            storageBucket: "mycallingapp-8677d.firebasestorage.app",
            messagingSenderId: "75951551570",
            appId: "1:75951551570:android:d7de2090c4c70bba7fdb8b"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        let myId = localStorage.getItem('saharaj_user_id');
        let myName = localStorage.getItem('saharaj_user_name');
        let localStream, pc, currentCallId, targetUserId;
        let isCamOn = true, isMicOn = true, isNoiseOn = false;

        // --- Auto Login & Network Monitor ---
        window.onload = () => {
            if (myId && myName) initApp();
            monitorNetwork();
        };

        function monitorNetwork() {
            setInterval(async () => {
                const start = Date.now();
                try {
                    await fetch('https://www.google.com/favicon.ico', { mode: 'no-cors' });
                    const latency = Date.now() - start;
                    updateSignalUI('mySignal', latency);
                    if(myId) db.collection('users').doc(myId).update({ net: latency });
                } catch(e) {}
            }, 5000);
        }

        function updateSignalUI(elementId, latency) {
            const bars = document.getElementById(elementId).querySelectorAll('.bar');
            bars.forEach(b => b.classList.remove('online-bar'));
            if (latency < 150) bars.forEach(b => b.classList.add('online-bar'));
            else if (latency < 400) { bars[0].classList.add('online-bar'); bars[1].classList.add('online-bar'); }
            else { bars[0].classList.add('online-bar'); }
        }

        async function initApp() {
            document.getElementById('auth-screen').style.display = 'none';
            document.getElementById('myDisplayName').innerText = "Hi, " + myName;
            
            // Register & Auto-Offline on close
            await db.collection('users').doc(myId).set({ name: myName, status: 'online', incoming: null, net: 0 });
            window.addEventListener('beforeunload', () => db.collection('users').doc(myId).update({ status: 'offline' }));

            localStream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
            document.getElementById('localVideo').srcObject = localStream;

            // Users & Incoming Calls
            db.collection('users').where('status', '==', 'online').onSnapshot(snap => {
                const list = document.getElementById('userList');
                list.innerHTML = '';
                snap.forEach(doc => {
                    if (doc.id !== myId) {
                        list.innerHTML += `<div style="background:white; padding:10px; margin:5px; border-radius:8px; display:flex; justify-content:space-between;">
                            <span>${doc.data().name} (ðŸ“¶${doc.data().net}ms)</span>
                            <button onclick="startCall('${doc.id}')" style="background:var(--success); color:white; border:none; padding:5px 15px; border-radius:5px;">Call</button>
                        </div>`;
                    }
                });
            });

            db.collection('users').doc(myId).onSnapshot(snap => {
                const data = snap.data();
                if (data?.incoming) {
                    currentCallId = data.incoming;
                    targetUserId = data.callerId;
                    document.getElementById('callerNameText').innerText = data.callerName + " is calling...";
                    document.getElementById('incoming-alert').style.display = 'block';
                }
                // Auto-Hangup if opponent goes offline
                if (data?.callEnded) endCall(false);
            });
        }

        // --- Calling Logic ---
        async function startCall(targetId) {
            targetUserId = targetId;
            setupPC();
            const callDoc = db.collection('calls').doc();
            currentCallId = callDoc.id;
            
            pc.onicecandidate = e => e.candidate && callDoc.collection('offCand').add(e.candidate.toJSON());
            const offer = await pc.createOffer();
            await pc.setLocalDescription(offer);
            await callDoc.set({ offer: { sdp: offer.sdp, type: offer.type } });

            await db.collection('users').doc(targetId).update({ incoming: callDoc.id, callerName: myName, callerId: myId });
            document.getElementById('call-screen').style.display = 'flex';
            
            callDoc.onSnapshot(s => { if(s.data()?.answer && !pc.currentRemoteDescription) pc.setRemoteDescription(new RTCSessionDescription(s.data().answer)) });
            callDoc.collection('ansCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            trackOpponentNet();
        }

        async function acceptCall() {
            document.getElementById('incoming-alert').style.display = 'none';
            document.getElementById('call-screen').style.display = 'flex';
            setupPC();
            const callDoc = db.collection('calls').doc(currentCallId);
            pc.onicecandidate = e => e.candidate && callDoc.collection('ansCand').add(e.candidate.toJSON());
            const callData = (await callDoc.get()).data();
            await pc.setRemoteDescription(new RTCSessionDescription(callData.offer));
            const answer = await pc.createAnswer();
            await pc.setLocalDescription(answer);
            await callDoc.update({ answer: { sdp: answer.sdp, type: answer.type } });
            callDoc.collection('offCand').onSnapshot(s => s.docChanges().forEach(c => c.type==='added' && pc.addIceCandidate(new RTCIceCandidate(c.doc.data()))));
            trackOpponentNet();
        }

        function trackOpponentNet() {
            db.collection('users').doc(targetUserId).onSnapshot(snap => {
                const net = snap.data()?.net || 0;
                document.getElementById('opp-signal').innerText = `Opponent Net: ${net}ms`;
                if(snap.data()?.status === 'offline') endCall();
            });
        }

        function setupPC() {
            pc = new RTCPeerConnection({ iceServers: [{ urls: ['stun:stun1.l.google.com:19302'] }] });
            const remoteStream = new MediaStream();
            localStream.getTracks().forEach(t => pc.addTrack(t, localStream));
            pc.ontrack = e => e.streams[0].getTracks().forEach(t => remoteStream.addTrack(t));
            document.getElementById('remoteVideo').srcObject = remoteStream;
        }

        // --- New Control Features ---
        function toggleCamera() {
            isCamOn = !isCamOn;
            localStream.getVideoTracks()[0].enabled = isCamOn;
            document.getElementById('camBtn').innerText = isCamOn ? "ðŸ“¹" : "ðŸš«";
            document.getElementById('camBtn').className = `control-btn ${isCamOn ? 'neutral-btn' : 'inactive-btn'}`;
        }

        function toggleMic() {
            isMicOn = !isMicOn;
            localStream.getAudioTracks()[0].enabled = isMicOn;
            document.getElementById('micBtn').innerText = isMicOn ? "ðŸŽ¤" : "ðŸ”‡";
        }

        async function toggleNoise() {
            isNoiseOn = !isNoiseOn;
            const audioTrack = localStream.getAudioTracks()[0];
            // Web Standard for basic noise suppression
            await audioTrack.applyConstraints({ noiseSuppression: isNoiseOn, echoCancellation: true });
            document.getElementById('noiseBtn').innerText = isNoiseOn ? "ðŸŒŸ" : "ðŸ”‡";
            alert("Noise Suppression " + (isNoiseOn ? "Enabled" : "Disabled"));
        }

        function toggleSpeaker() {
            const video = document.getElementById('remoteVideo');
            // Browser limited: toggles between mute and full volume
            video.muted = !video.muted;
            document.getElementById('spkBtn').innerText = video.muted ? "ðŸ”ˆ" : "ðŸ”Š";
        }

        function handleRegister() {
            const name = document.getElementById('usernameInput').value;
            if (!name) return alert("Enter Name");
            myId = name + "_" + Math.floor(Math.random() * 9999);
            myName = name;
            localStorage.setItem('saharaj_user_id', myId);
            localStorage.setItem('saharaj_user_name', myName);
            initApp();
        }

        async function endCall(notify = true) {
            if(notify && targetUserId) await db.collection('users').doc(targetUserId).update({ callEnded: true });
            location.reload();
        }

        function logout() { localStorage.clear(); location.reload(); }
        function rejectCall() { db.collection('users').doc(myId).update({ incoming: null }); document.getElementById('incoming-alert').style.display = 'none'; }
    </script>
</body>
</html>
